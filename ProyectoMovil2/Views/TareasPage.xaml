<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ProyectoMovil2.Views.TareasPage"
             x:DataType="viewmodels:TareasViewModel"
             xmlns:viewmodels="clr-namespace:ProyectoMovil2.ViewModels"
             Title="Base de datos"
             xmlns:models="clr-namespace:ProyectoMovil2.Models">
    

    <Grid RowDefinitions="Auto,*" Padding="0">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Padding="20" Spacing="10" BackgroundColor="#007ACC">
            <Label 
                Text="Tareas"
                FontSize="28"
                FontAttributes="Bold"
                TextColor="White"
                HorizontalOptions="Center" />

            <!-- BotÃ³n Crear Tarea -->
            <Button 
                Text="+ Nueva Tarea"
                Command="{Binding CrearTareaCommand}"
                BackgroundColor="#28a745"
                TextColor="White"
                CornerRadius="10"
                HeightRequest="45"
                Margin="20,5" />
        </VerticalStackLayout>

        <!-- Lista de Tareas con RefreshView -->
        <RefreshView 
            Grid.Row="1"
            IsRefreshing="{Binding IsRefreshing}"
            Command="{Binding RefreshCommand}">

            <ScrollView>
                <VerticalStackLayout Padding="15" Spacing="15">

                    <!-- Indicador de carga -->
                    <ActivityIndicator 
                        IsRunning="{Binding IsBusy}"
                        IsVisible="{Binding IsBusy}"
                        Color="#007ACC"
                        HeightRequest="50" />

                    <!-- Mensaje de error -->
                    <Label 
                        Text="{Binding MensajeError}"
                        TextColor="Red"
                        IsVisible="{Binding MensajeError, Converter={StaticResource StringNotEmptyConverter}}"
                        HorizontalOptions="Center"
                        FontSize="14"
                        Margin="0,10,0,0" />

                    <!-- CollectionView de Tareas -->
                    <CollectionView 
                        ItemsSource="{Binding Tareas}"
                        EmptyView="No hay tareas disponibles"
                        IsVisible="{Binding IsNotBusy}">

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Tarea">
                                <Frame 
                                    Padding="15"
                                    Margin="0,5"
                                    CornerRadius="10"
                                    BorderColor="#DDDDDD"
                                    HasShadow="True"
                                    BackgroundColor="White">

                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto">

                                        <!-- TÃ­tulo -->
                                        <Label 
                                            Grid.Row="0" Grid.Column="0"
                                            Text="{Binding Titulo}"
                                            FontSize="18"
                                            FontAttributes="Bold"
                                            TextColor="#333333" />

                                        <!-- Estatus Badge -->
                                        <Border
                                            Grid.Row="0" Grid.Column="1"
                                            BackgroundColor="{Binding EstatusColor}"
                                            StrokeThickness="0"
                                            Padding="8,4"
                                            Margin="5,0,0,0"
                                            StrokeShape="RoundRectangle 12">
                                            <Label 
                                                Text="{Binding EstatusTexto}"
                                                FontSize="12"
                                                TextColor="White"
                                                FontAttributes="Bold" />
                                        </Border>

                                        <!-- DescripciÃ³n -->
                                        <Label 
                                            Grid.Row="1" Grid.ColumnSpan="2"
                                            Text="{Binding Descripcion}"
                                            FontSize="14"
                                            TextColor="#666666"
                                            Margin="0,5,0,0"
                                            LineBreakMode="WordWrap" />

                                        <!-- Fecha de Entrega -->
                                        <HorizontalStackLayout 
                                            Grid.Row="2" Grid.ColumnSpan="2"
                                            Margin="0,10,0,0"
                                            Spacing="5">
                                            <Label 
                                                Text="ðŸ“…"
                                                FontSize="14" />
                                            <Label 
                                                Text="Entrega:"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                TextColor="#007ACC" />
                                            <Label 
                                                Text="{Binding FechaEntregaTexto}"
                                                FontSize="14"
                                                TextColor="#666666" />
                                        </HorizontalStackLayout>

                                        <!-- Botones de AcciÃ³n -->
                                        <VerticalStackLayout 
                                            Grid.Row="3" Grid.ColumnSpan="2"
                                            Spacing="10"
                                            Margin="0,15,0,0">

                                            <!-- Botones para tareas NO entregadas -->
                                            <Grid 
                                                ColumnDefinitions="*,*,*"
                                                ColumnSpacing="8"
                                                IsVisible="{Binding Estatus, Converter={StaticResource InverseBoolConverter}}">

                                                <Button 
                                                    Grid.Column="0"
                                                    Text="âœ… Entregar"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TareasViewModel}}, Path=MarcarEntregadaCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#28a745"
                                                    TextColor="White"
                                                    CornerRadius="8"
                                                    HeightRequest="40"
                                                    FontSize="12" />

                                                <Button 
                                                    Grid.Column="1"
                                                    Text="âœï¸ Editar"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TareasViewModel}}, Path=EditarTareaCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#ffc107"
                                                    TextColor="White"
                                                    CornerRadius="8"
                                                    HeightRequest="40"
                                                    FontSize="12" />

                                                <Button 
                                                    Grid.Column="2"
                                                    Text="ðŸ—‘ï¸ Eliminar"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TareasViewModel}}, Path=EliminarTareaCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#dc3545"
                                                    TextColor="White"
                                                    CornerRadius="8"
                                                    HeightRequest="40"
                                                    FontSize="12" />
                                            </Grid>

                                            <!-- Mensaje para tareas entregadas -->
                                            <Border
                                                BackgroundColor="#d4edda"
                                                StrokeThickness="1"
                                                Stroke="#c3e6cb"
                                                Padding="10"
                                                StrokeShape="RoundRectangle 8"
                                                IsVisible="{Binding Estatus}">
                                                <Label 
                                                    Text="âœ… Tarea entregada - No se puede editar ni eliminar"
                                                    TextColor="#155724"
                                                    FontSize="12"
                                                    FontAttributes="Bold"
                                                    HorizontalOptions="Center" />
                                            </Border>

                                        </VerticalStackLayout>

                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                </VerticalStackLayout>
            </ScrollView>

        </RefreshView>

    </Grid>

</ContentPage>